## Global options
{
    # Admin accesible only in this virtual network
    admin caddy-admin:2019
    # Enable per-host metrics
    metrics {
        per_host
    }

    # JSON logging for Fail2ban integration
    log {
        output file /var/log/caddy/access.log {
            roll_size 100mb
            roll_keep 5
        }
        format json
    }
}

<protocol>://<domain> {
    reverse_proxy navidrome:4533
}

<protocol>://<domain>:4533 {
    redir <protocol>://<domain>{uri} permanent
}

<protocol>://wud.<domain> {
    basicauth {
        <caddy_auth_user> <caddy_auth_password_hash>
    }
    route {
        reverse_proxy wud:2999
    }
}

<protocol>://grafana.<domain> {
    basicauth {
        <caddy_auth_user> <caddy_auth_password_hash>
    }
    route {
        reverse_proxy grafana:3000
    }
}

<protocol>://syncthing.<domain> {
    basicauth {
        <caddy_auth_user> <caddy_auth_password_hash>
    }
    route {
        reverse_proxy syncthing:8384
    }
}

<protocol>://filebrowser.<domain> {
    route {
        reverse_proxy filebrowser:8080
    }
}

<protocol>://picard.<domain> {
    route {
        reverse_proxy https://picard:5800 {
            transport http {
                tls_insecure_skip_verify
            }
        }
    }
}

# Internal monitoring endpoints - do NOT expose to the internet
<protocol>://prometheus.<domain> {
    @allowed client_ip 127.0.0.1 172.16.0.0/8 192.168.0.0/16
    handle @allowed {
        reverse_proxy prometheus:9090
    }
    handle {
        abort
    }
}
