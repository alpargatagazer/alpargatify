services:

  wud:
    image: getwud/wud:main
    profiles: [ "wud" ]
    container_name: wud
    entrypoint: [ "${CONTAINER_ENTRYPOINT_PATH:-/entrypoint.sh}" ]
    labels:
      wud.watch: false
    environment:
      TZ: ${TZ}
      WUD_SERVER_PORT: 2999
      WUD_WATCHER_LOCAL_CRON: 0 6 * * *
      WUD_AUTH_BASIC_ADMIN_USER: ${WUD_ADMIN_USER}
      # WUD_AUTH_BASIC_ADMIN_HASH is injected by entrypoint from secret
      # Compose triggers
      WUD_TRIGGER_DOCKERCOMPOSE_CORE_FILE: /wud/docker-compose-core.yml
      WUD_TRIGGER_DOCKERCOMPOSE_CORE_PRUNE: true
      WUD_TRIGGER_DOCKERCOMPOSE_CORE_AUTO: false
      WUD_TRIGGER_DOCKERCOMPOSE_EXTRATOOLS_FILE: /wud/docker-compose-extratools.yml
      WUD_TRIGGER_DOCKERCOMPOSE_EXTRATOOLS_PRUNE: true
      WUD_TRIGGER_DOCKERCOMPOSE_EXTRATOOLS_AUTO: false
      WUD_TRIGGER_DOCKERCOMPOSE_MONITOR_FILE: /wud/docker-compose-monitor.yml
      WUD_TRIGGER_DOCKERCOMPOSE_MONITOR_PRUNE: true
      WUD_TRIGGER_DOCKERCOMPOSE_MONITOR_AUTO: false
      WUD_TRIGGER_DOCKERCOMPOSE_NETWORK_FILE: /wud/docker-compose-network.yml
      WUD_TRIGGER_DOCKERCOMPOSE_NETWORK_PRUNE: true
      WUD_TRIGGER_DOCKERCOMPOSE_NETWORK_AUTO: false
      WUD_TRIGGER_DOCKERCOMPOSE_STORAGE_FILE: /wud/docker-compose-storage.yml
      WUD_TRIGGER_DOCKERCOMPOSE_STORAGE_PRUNE: true
      WUD_TRIGGER_DOCKERCOMPOSE_STORAGE_AUTO: false
    secrets:
      - wud_admin_password_hash
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./docker-compose-core.yml:/wud/docker-compose-core.yml
      - ./docker-compose-extratools.yml:/wud/docker-compose-extratools.yml
      - ./docker-compose-monitor.yml:/wud/docker-compose-monitor.yml
      - ./docker-compose-network.yml:/wud/docker-compose-network.yml
      - ./docker-compose-storage.yml:/wud/docker-compose-storage.yml
      - ./configs/entrypoints/wud.sh:${CONTAINER_ENTRYPOINT_PATH:-/entrypoint.sh}:ro
    networks:
      - frontend
      - monitoring
    restart: unless-stopped
    healthcheck:
      test: curl --fail http://127.0.0.1:2999/health || exit 1
      interval: 10s
      timeout: 10s
      retries: 3

  picard:
    image: jlesage/musicbrainz-picard:latest
    profiles: [ "picard" ]
    container_name: picard
    entrypoint: [ "${CONTAINER_ENTRYPOINT_PATH:-/entrypoint.sh}" ]
    labels:
      - 'wud.tag.include=^v\d+\.\d+\.\d+$$'
    environment:
      TZ: ${TZ}
      USER_ID: ${PUID}
      GROUP_ID: ${PGID}
      SECURE_CONNECTION: 1
      WEB_AUTHENTICATION: 1
      WEB_AUTHENTICATION_USERNAME: ${PICARD_ADMIN_USER}
      # WEB_AUTHENTICATION_PASSWORD is injected by entrypoint from secret
      DARK_MODE: 1
      TAKE_CONFIG_OWNERSHIP: 1
    secrets:
      - picard_admin_password
    volumes:
      - "${VOLUMES_PATH}/picard:/config"
      - "${NAVIDROME_MUSIC_PATH}:/storage/music:rw"
      - "${NAVIDROME_EXTRA_LIBRARIES_PATH}:/storage/extra-libraries:rw"
      - "./configs/entrypoints/picard.sh:${CONTAINER_ENTRYPOINT_PATH:-/entrypoint.sh}:ro"
    networks:
      - frontend
    restart: unless-stopped

  dozzle:
    image: amir20/dozzle:latest
    profiles: [ "dozzle" ]
    container_name: dozzle
    labels:
      - 'wud.tag.include=latest'
      - 'wud.watch.digest=true'
    environment:
      TZ: ${TZ}
      DOZZLE_NO_ANALYTICS: true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - frontend
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "/dozzle", "healthcheck" ]
      interval: 3s
      timeout: 30s
      retries: 5
      start_period: 30s

secrets:
  wud_admin_password_hash:
    file: ${SECRETS_PATH}/wud_admin_password_hash
  picard_admin_password:
    file: ${SECRETS_PATH}/picard_admin_password
