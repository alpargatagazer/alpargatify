services:

  navidrome:
    image: deluan/navidrome:0.60.3
    user: ${PUID}:${PGID}
    container_name: navidrome
    entrypoint: [ "${CONTAINER_ENTRYPOINT_PATH:-/entrypoint.sh}" ]
    labels:
      - 'wud.tag.include=^\d+\.\d+\.\d+$$'
    environment:
      TZ: ${TZ}
      ND_CONFIGFILE: /navidrome.toml
      ND_LASTFM_APIKEY: ${LASTFM_APIKEY}
      # ND_LASTFM_SECRET is injected by entrypoint from secret
      ND_PROMETHEUS_METRICSPATH: ${CUSTOM_METRICS_PATH}
      ND_PROMETHEUS_PASSWORD: ${NAVIDROME_METRICS_PASSWORD}
      # Backups are saved under your Navidrome volume
      ND_BACKUP_PATH: /data/backup/
      # ND_PASSWORDENCRYPTIONKEY is injected by entrypoint from secret
    secrets:
      - lastfm_secret
      - navidrome_encryption_key
    volumes:
      - "${NAVIDROME_MUSIC_PATH}:/music:ro"
      - "${NAVIDROME_EXTRA_LIBRARIES_PATH}:/extra-libraries:ro"
      - "${VOLUMES_PATH}/navidrome:/data"
      - "./configs/navidrome.toml:/navidrome.toml:ro"
      - "./configs/entrypoints/navidrome.sh:${CONTAINER_ENTRYPOINT_PATH:-/entrypoint.sh}:ro"
    networks:
      - frontend
      - monitoring
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "sh", "-c", "wget --quiet --tries=1 --timeout=3 -O - http://127.0.0.1:4533/ || exit 1" ]
      interval: 1m
      timeout: 10s
      retries: 3

  init-chown:
    image: alpine:latest
    container_name: init-chown
    labels:
      - 'wud.tag.include=latest'
      - 'wud.watch.digest=true'
    # run as root (default) and perform a safe chown only when /volumes and /music exists
    command: >
      sh -euxc '
        if [ -d /volumes ]; then
          echo "Init: fixing ownership of /volumes to ${PUID:-1000}:${PGID:-1000}";
          chown -R ${PUID:-1000}:${PGID:-1000} /volumes || true;
        else
          echo "Init: /volumes not found, skipping";
        fi
        if [ -d /music ]; then
          echo "Init: fixing ownership of /music to ${PUID:-1000}:${PGID:-1000}";
          chown -R ${PUID:-1000}:${PGID:-1000} /music || true;
        else
          echo "Init: /music not found, skipping";
        fi
      '
    volumes:
      - ${VOLUMES_PATH}:/volumes:rw
      - ${NAVIDROME_MUSIC_PATH}:/music/main:rw
      - ${NAVIDROME_EXTRA_LIBRARIES_PATH}:/music/extra:rw
    networks:
      - internal
    # do not restart; it's a one-shot
    restart: "no"

networks:
  internal:
  frontend:
    # Best when working in virtualized environments 
    driver_opts:
      com.docker.network.driver.mtu: 1450
  monitoring:
    driver_opts:
      com.docker.network.driver.mtu: 1450
  caddy-with-admin:
    driver_opts:
      com.docker.network.driver.mtu: 1450

secrets:
  lastfm_secret:
    file: ${SECRETS_PATH}/lastfm_secret
  navidrome_encryption_key:
    file: ${SECRETS_PATH}/navidrome_encryption_key
